{"version":3,"file":"shared-components-SubjectPicker-SubjectPicker-stories.04acef51.iframe.bundle.js","mappings":";;AAsBA;;AAIA;;;;;AAKA;AACA;;;AAGA;;;;;AAKA;;AAEA","sources":["webpack://@zooniverse/fe-project/./src/shared/components/SubjectPicker/SubjectPicker.jsx"],"sourcesContent":["import { PlainButton, SpacedText } from '@zooniverse/react-components'\nimport { debounce } from 'lodash'\nimport Link from 'next/link'\nimport { array, bool, number, shape, string } from 'prop-types'\nimport { useEffect, useState } from 'react'\nimport styled from 'styled-components'\nimport { Box, DataTable, Heading, Paragraph } from 'grommet'\nimport { useTranslation } from 'next-i18next'\n\nimport addQueryParams from '@helpers/addQueryParams'\nimport { columns, fetchStatuses, fetchSubjects, searchParams } from './helpers'\n\n/*\n  Grommet is opinionated about line-height and links it to font-size.\n  Reset the heading baselines here so that spacing is measured from\n  the tops and bottoms of the letters (without changing the text size.)\n  https://matthiasott.com/notes/the-thing-with-leading-in-css\n*/\n\nexport const StyledBox = styled(Box)`\n  min-height: 30px;\n`\nexport const StyledHeading = styled(Heading)`\n  line-height: 100%;\n`\n\nexport const SubjectDataTable = styled(DataTable)`\n  button {\n    padding: 0;\n  }\n  thead th {\n    background: ${props => props.theme.global.colors[props.background.header]};\n    padding: ${props => props.theme.global.edgeSize[props.pad.header]}\n  }\n  th button {\n    color: ${props => props.theme.global.colors['dark-1']};\n    font-weight: bold;\n    text-transform: uppercase;\n  }\n  th svg {\n    stroke: ${props => props.theme.global.colors['dark-1']};\n  }\n`\n\nconst PAGE_SIZE = 10\n\nexport default function SubjectPicker({ baseUrl, subjectSet, workflow }) {\n  const { t } = useTranslation('components')\n  const [ rows, setRows ] = useState([])\n  const [ query, setQuery ] = useState('')\n  const [ isFetching, setIsFetching ] = useState(false)\n  const [ sortField, setSortField ] = useState('priority')\n  const [ sortOrder, setSortOrder ] = useState('asc')\n  const { indexFields } = subjectSet.metadata\n  const customHeaders = indexFields.split(',')\n\n  rows.forEach(row => {\n    row.status = t(row.status)\n  })\n\n  useEffect(function onChange() {\n    async function fetchSubjectData() {\n      // Resetting the rows is important when fetchSubjectData() occurs as a\n      // result of changing the sort order, when the number of subjects exceeds\n      // PAGE_SIZE. Otherwise, we see a \"visual hiccup\" where the SubjectPicker\n      // first sorts the OLD set of subjects (say) 1-100, then fetches the new set\n      // of subjects (say) 899-999 (with the opposite sort logic), then sorts the\n      // new set.\n      // See https://github.com/zooniverse/front-end-monorepo/pull/2466#issuecomment-931547044\n      // for details.\n      setIsFetching(true)\n\n      const subjects = await fetchSubjects(subjectSet.id, query, sortField, sortOrder)\n      const newRows = await fetchStatuses(subjects, workflow, PAGE_SIZE)\n      setRows(newRows)\n      setIsFetching(false)\n    }\n\n    fetchSubjectData()\n  }, [query, sortField, sortOrder, subjectSet.id, workflow])\n\n  function search(data) {\n    const query = searchParams(data)\n    setQuery(query)\n  }\n\n  function sort(data) {\n    const { property: sortField, direction: sortOrder } = data\n    if (sortField === 'status') {\n      return true\n    }\n    setRows([])\n    setSortField(sortField)\n    setSortOrder(sortOrder)\n    return true\n  }\n\n  const background = {\n    header: \"accent-2\",\n    body: [\"white\", \"light-1\"]\n  }\n  const pad = {\n    header: \"xsmall\",\n    body: \"xsmall\"\n  }\n\n  /*\n    Vertical spacing for the picker instructions.\n    The theme's named margins are set in multiples of 10px, so set 15px explicitly.\n  */\n  const textMargin = {\n    top: '15px',\n    bottom: 'medium'\n  }\n  return (\n    <>\n      <PlainButton\n        forwardedAs={Link}\n        href={addQueryParams(baseUrl)}\n        text={t('SubjectPicker.back')}\n      />\n      <StyledHeading\n        level={3}\n        margin={{ top: 'xsmall', bottom: 'none' }}\n      >\n        {t('SubjectPicker.heading')}\n      </StyledHeading>\n      <Paragraph\n        margin={textMargin}\n      >\n        {t('SubjectPicker.byline')}\n      </Paragraph>\n      <StyledBox\n        background='brand'\n        fill\n        pad={{\n          top: '5px',\n          bottom: 'none',\n          horizontal: 'none'\n        }}\n      >\n        <Paragraph\n          color=\"white\"\n          margin='none'\n          textAlign='center'\n        >\n          <SpacedText\n            margin='medium'\n            weight='bold'\n          >\n            {subjectSet.display_name}\n          </SpacedText>\n        </Paragraph>\n      </StyledBox>\n      <SubjectDataTable\n        background={background}\n        columns={columns(customHeaders, `${baseUrl}/subject-set/${subjectSet.id}`)}\n        data={rows}\n        fill\n        onSearch={debounce(search, 500)}\n        onSort={sort}\n        pad={pad}\n        pin\n        replace\n        sortable\n        step={PAGE_SIZE}\n      />\n      {isFetching && (\n        <Paragraph textAlign=\"center\">{t('SubjectPicker.fetching')}</Paragraph>\n      )}\n    </>\n  )\n}\n\nSubjectPicker.propTypes = {\n  /**\n    Base URL for links eg. `/${owner}/${project}/classify/workflow/${workflow.id}`\n  */\n  baseUrl: string.isRequired,\n  /**\n    The selected subject set.\n  */\n  subjectSet: shape({\n    completeness: number,\n    display_name: string,\n    id: string,\n    subjects: array\n  }),\n  /**\n    The selected workflow.\n  */\n  workflow: shape({\n    completeness: number,\n    default: bool,\n    display_name: string,\n    id: string,\n    subjectSets: array\n  }).isRequired\n}\n"],"names":[],"ignoreList":[],"sourceRoot":""}