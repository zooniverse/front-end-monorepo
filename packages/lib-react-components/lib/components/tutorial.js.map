{"version":3,"sources":["../../src/components/tutorial.jsx"],"names":["completedThisSession","Tutorial","props","previousActiveElement","document","activeElement","handleNextClick","bind","handleUnmount","stepThrough","goNext","focus","now","Date","toISOString","tutorial","id","user","projectPreferences","preferences","tutorials_completed_at","changes","update","save","isIE","window","tutorialStyle","height","el","steps","map","step","i","_key","Math","random","source","button","media","src","length","content","Component","checkIfCompleted","prefs","Promise","resolve","startIfNecessary","self","then","completed","start","find","workflow","apiClient","type","get","workflow_id","tutorials","onlyStandardTutorials","filter","kind","TutorialComponent","awaitTutorialMedia","catch","mediaResources","mediaByID","mediaResource","Dialog","alert","className","required","closeButton","propTypes","PropTypes","shape","object","array","defaultProps"],"mappings":"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","file":"tutorial.js","sourcesContent":["import React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport Dialog from 'modal-form/dialog';\nimport MediaCard from './media-card';\nimport { Markdown } from 'markdownz';\nimport apiClient from 'panoptes-client/lib/api-client';\nimport StepThrough from '../components/step-through';\n\nconst completedThisSession = {};\n// TODO fix [window is undefined](https://github.com/zeit/next.js/wiki/FAQ) issue\n// if (window && window.tutorialsCompletedThisSession) {\n//   window.tutorialsCompletedThisSession = completedThisSession;\n// }\n\nclass Tutorial extends Component {\n  constructor(props) {\n    super(props);\n\n    this.previousActiveElement = document.activeElement;\n    this.handleNextClick = this.handleNextClick.bind(this);\n  }\n\n  componentWillUnmount() {\n    this.handleUnmount();\n  }\n\n  handleNextClick() {\n    this.stepThrough.goNext();\n  }\n\n  handleUnmount() {\n    if (this.previousActiveElement.focus) {\n      this.previousActiveElement.focus();\n    }\n    const now = new Date().toISOString();\n    completedThisSession[this.props.tutorial.id] = now;\n\n    if (this.props.user) {\n      const projectPreferences = this.props.preferences;\n      if (!projectPreferences.preferences) {\n        projectPreferences.preferences = {};\n      };\n      if (!projectPreferences.preferences.tutorials_completed_at) {\n        projectPreferences.preferences.tutorials_completed_at = {};\n      };\n      const changes = {};\n      changes[`preferences.tutorials_completed_at.${this.props.tutorial.id}`] = now;\n      projectPreferences.update(changes);\n      projectPreferences.save();\n    }\n  }\n\n  render() {\n    const isIE = 'ActiveXObject' in window;\n    let tutorialStyle;\n\n    if (isIE) {\n      tutorialStyle = { height: '85vh' };\n    };\n\n    return (\n      <StepThrough ref={(el) => { this.stepThrough = el; }} className=\"tutorial-steps\" style={tutorialStyle}>\n        {this.props.tutorial.steps.map((step, i) => {\n          if (!step._key) {\n            step._key = Math.random();\n          };\n          let source;\n          let button;\n\n          if (this.props.media[step.media]) {\n            source = this.props.media[step.media].src;\n          };\n          if (i === this.props.tutorial.steps.length - 1) {\n            button = <button type=\"submit\" className=\"major-button\">Letâ€™s go!</button>;\n          } else {\n            button = <button type=\"button\" className=\"standard-button\" onClick={this.handleNextClick}>Continue</button>;\n          }\n\n          return (\n            <MediaCard key={step._key} className=\"tutorial-step\" src={source}>\n              <Markdown>{step.content}</Markdown>\n              <hr />\n              <p>\n                {button}\n              </p>\n            </MediaCard>\n          );\n        })}\n      </StepThrough>\n    );\n  }\n};\n\nTutorial.checkIfCompleted = (tutorial, user, preferences) => {\n  if (user) {\n    window.prefs = preferences;\n    if (preferences && preferences.preferences && preferences.preferences.tutorials_completed_at && preferences.preferences.tutorials_completed_at[tutorial.id]) {\n      return Promise.resolve(true);\n    }\n    return Promise.resolve(false);\n  } else {\n    return Promise.resolve(!!completedThisSession[tutorial.id]);\n  }\n};\n\nTutorial.startIfNecessary = (self, tutorial, user, preferences) => {\n  if (tutorial) {\n    self.checkIfCompleted(tutorial, user, preferences).then((completed) => {\n      if (!completed) {\n        self.start(self, tutorial, user, preferences);\n      }\n    });\n  }\n}\n\nTutorial.find = (workflow) => {\n  if (workflow) {\n    return apiClient.type('tutorials').get({ workflow_id: workflow.id })\n      .then((tutorials) => {\n        const onlyStandardTutorials = tutorials.filter((tutorial) => {\n          return tutorial.kind === 'tutorial' || null;\n        })\n        return onlyStandardTutorials[0];\n      })\n  } else {\n    return Promise.resolve(false)\n  }\n}\n\nTutorial.start = (TutorialComponent, tutorial, user, preferences) => {\n  if (tutorial.steps.length !== 0) {\n    const awaitTutorialMedia = tutorial.get('attached_images')\n      .catch(() => {\n        return [];\n      })\n      .then((mediaResources) => {\n        const mediaByID = {};\n\n        mediaResources.map((mediaResource) => {\n          mediaByID[mediaResource.id] = mediaResource;\n        });\n        return mediaByID;\n      });\n\n    awaitTutorialMedia.then((mediaByID) => {\n      Dialog.alert(<TutorialComponent tutorial={tutorial} media={mediaByID} preferences={preferences} user={user} />, {\n        className: 'tutorial-dialog',\n        required: true,\n        closeButton: true\n      })\n      .catch(() => {\n        return null;\n      });\n    });\n  }\n};\n\nTutorial.propTypes = {\n  preferences: PropTypes.shape({\n    preferences: PropTypes.object\n  }),\n  tutorial: PropTypes.shape({\n    steps: PropTypes.array\n  }),\n  user: PropTypes.object\n};\n\nTutorial.defaultProps = {\n  media: {},\n  preferences: null,\n  tutorial: {\n    steps: []\n  },\n  user: null,\n};\n\nexport default Tutorial;\n"]}